<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sports Meet Registration - Sunrise English Private School</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-r from-indigo-50 to-blue-100 min-h-screen font-sans">

<!-- Registration Form -->
<div id="mainContainer" class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl mt-10 p-8 border border-blue-200">
  <h1 class="text-4xl font-bold text-center text-indigo-700 mb-4">SUNRISE ENGLISH PRIVATE SCHOOL - L.L.C - O.P.C- ABU DHABI</h1>
  <h2 class="text-lg font-bold text-center text-gray-700 mb-8">ANNUAL SPORTS MEET 2025–2026 Registration</h2>

  <form id="sportsForm" class="space-y-6">
    <div>
      <label class="block font-semibold text-gray-700">Full Name</label>
      <input type="text" id="name" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold text-gray-700">GR Number</label>
        <input type="text" id="grNo" maxlength="5" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
      </div>
      <div>
        <label class="block font-semibold text-gray-700">Class</label>
        <input type="text" id="class" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold text-gray-700">Division</label>
        <input type="text" id="division" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
      </div>
      <div>
        <label class="block font-semibold text-gray-700">Sports House</label>
        <select id="house" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
          <option value="">Select House</option>
          <option value="Ruby">Ruby</option>
          <option value="Sapphire">Sapphire</option>
          <option value="Topaz">Topaz</option>
          <option value="Emerald">Emerald</option>
        </select>
      </div>
    </div>
    <div>
      <label class="block font-semibold text-gray-700">Date of Birth</label>
      <input type="date" id="dob" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-indigo-400" required>
    </div>
    <div>
      <label class="block font-semibold text-gray-700">Category</label>
      <input type="text" id="category" class="border p-2 w-full rounded-md bg-gray-100 text-gray-600" readonly>
    </div>
    <div id="eventsSection" class="hidden">
      <label class="block font-semibold text-gray-700 mb-2">Select Events</label>
      <div id="eventList" class="grid grid-cols-2 gap-2"></div>
      <p id="eventNote" class="text-sm text-gray-600 mt-2"></p>
    </div>
    <button type="submit" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 w-full font-semibold">Submit Registration</button>
  </form>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden max-w-5xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow-lg">
  <h2 class="text-2xl font-bold text-indigo-700 mb-4 text-center">Admin Panel - Sports Meet 2025</h2>
  <div class="flex flex-wrap justify-between mb-4 space-x-2">
    <select id="filterCategory" class="border p-2 rounded-md">
      <option value="">Select Category</option>
      <option value="Sub Junior">Sub Junior</option>
      <option value="Junior">Junior</option>
      <option value="Inter">Inter</option>
      <option value="Senior">Senior</option>
      <option value="Super Senior">Super Senior</option>
    </select>
    <select id="filterEvent" class="border p-2 rounded-md">
      <option value="">Select Event</option>
    </select>
    <button id="downloadFilteredPDF" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Download Filtered PDF</button>
    <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Export to CSV</button>
    <button id="backToRegistration" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Back to Registration</button>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 text-sm">
      <thead class="bg-indigo-100">
        <tr>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">GR No</th>
          <th class="border px-2 py-1">Class</th>
          <th class="border px-2 py-1">Div</th>
          <th class="border px-2 py-1">House</th>
          <th class="border px-2 py-1">Category</th>
          <th class="border px-2 py-1">Events</th>
          <th class="border px-2 py-1">Action</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </div>
</div>

<script>
// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "AIzaSyC-axJOwivMy-bGhNmVIHaXORcG90gLA9g",
  authDomain: "registration-c78dc.firebaseapp.com",
  databaseURL: "https://registration-c78dc-default-rtdb.firebaseio.com",
  projectId: "registration-c78dc",
  storageBucket: "registration-c78dc.appspot.com",
  messagingSenderId: "368136278543",
  appId: "1:368136278543:web:03a46a62d1095f40a0497a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Category & Events ---
const categories=[
{name:'Sub Junior',limit:2,min:new Date('2017-01-01')},
{name:'Junior',limit:3,min:new Date('2015-01-01')},
{name:'Inter',limit:3,min:new Date('2013-01-01')},
{name:'Senior',limit:4,min:new Date('2010-01-01')},
{name:'Super Senior',limit:4,min:new Date('2007-01-01')}
];
const eventsByCategory={
'Sub Junior':['100 mts','200 mts','Long Jump'],
'Junior':['100 mts','200 mts','400 mts','Long Jump'],
'Inter':['100 mts','200 mts','800 mts','Long Jump','Shot Put (4kg)'],
'Senior':['100 mts','200 mts','400 mts','800 mts','Long Jump','Shot Put','1500 mts'],
'Super Senior':['100 mts','200 mts','400 mts','800 mts','Long Jump','Shot Put','1500 mts']
};

// --- Elements ---
const form=document.getElementById('sportsForm');
const dobInput=document.getElementById('dob');
const categoryField=document.getElementById('category');
const eventsSection=document.getElementById('eventsSection');
const eventList=document.getElementById('eventList');
const eventNote=document.getElementById('eventNote');

// --- Determine Category ---
dobInput.addEventListener('change',()=>{
  const dob = new Date(dobInput.value);
  let cat='Super Senior';
  for(let c of categories){ if(dob >= c.min){ cat=c.name; break; } }
  categoryField.value=cat;
  // Show Events
  eventsSection.classList.remove('hidden');
  eventList.innerHTML='';
  const limit = categories.find(c=>c.name===cat).limit;
  eventNote.textContent=`You can select up to ${limit} events.`;
  eventsByCategory[cat].forEach(ev=>{
    const label=document.createElement('label');
    label.className='flex items-center space-x-2';
    label.innerHTML=`<input type='checkbox' value='${ev}' class='eventCheck'> <span>${ev}</span>`;
    eventList.appendChild(label);
  });
  document.querySelectorAll('.eventCheck').forEach(chk=>{
    chk.addEventListener('change',()=>{
      if(document.querySelectorAll('.eventCheck:checked').length>limit){chk.checked=false;alert(`You can select only ${limit} events.`);}
    });
  });
});

// --- Submit Registration ---
form.addEventListener('submit', e=>{
  e.preventDefault();
  const name=form.name.value.trim();
  const grNo=form.grNo.value.trim();
  const classVal=form.class.value.trim();
  const division=form.division.value.trim();
  const house=form.house.value;
  const dob=dobInput.value;
  const category=categoryField.value;
  const events=Array.from(document.querySelectorAll('.eventCheck:checked')).map(c=>c.value);
  if(events.length===0){alert('Select at least one event'); return;}
  
  const student={name, grNo, class: classVal, division, house, dob, category, events};
  db.ref('registrations/'+grNo).set(student, err=>{
    if(err){alert('Error saving registration'); return;}
    alert('Registration successful!');
    generatePDF(student);
    form.reset();
    categoryField.value='';
    eventsSection.classList.add('hidden');
  });
});

// --- Generate PDF ---
function generatePDF(data){
  const content=document.createElement('div');
  content.style.padding='20px';
  content.style.fontFamily='Arial,sans-serif';
  content.innerHTML=`
  <div style="text-align:center;font-weight:bold;">SUNRISE ENGLISH PRIVATE SCHOOL - L.L.C - O.P.C- ABU DHABI</div>
  <div style="text-align:center;font-weight:bold;margin-bottom:15px;">ANNUAL SPORTS MEET 2025-2026</div>
  <p>Dear Parents,</p>
  <p>Full name of the student: ${data.name}</p>
  <p>Class: ${data.class}</p>
  <p>Division: ${data.division}</p>
  <p>Date of Birth: ${data.dob}</p>
  <p>GR NO: ${data.grNo}</p>
  <p>Sports House: ${data.house}</p>
  <p>CATEGORY: ${data.category}</p>
  <p>Events:</p>
  <ul>${data.events.map(e=>`<li>${e}</li>`).join('')}</ul>
  <p>Allow / Don’t Allow: ________________________</p>
  `;
  html2pdf().set({margin:[10,10,10,10], filename:`${data.name}_SportsMeet.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'}}).from(content).save();
}

// --- Admin Button ---
const adminBtn=document.createElement('button');
adminBtn.textContent='Open Admin Panel';
adminBtn.className='fixed top-2 right-2 bg-red-600 text-white px-4 py-2 rounded z-50';
document.body.appendChild(adminBtn);
adminBtn.addEventListener('click', ()=>{
  const pass=prompt('Enter admin password:');
  if(pass==='SUN2025'){
    document.getElementById('mainContainer').classList.add('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
    loadAdminData();
  }else alert('Incorrect password');
});

// --- Load Admin Data ---
function loadAdminData(filterCat='', filterEvent=''){
  db.ref('registrations').once('value', snapshot=>{
    let data = snapshot.val() || {};
    let rows='';
    Object.values(data).forEach(d=>{
      if(filterCat && d.category!==filterCat) return;
      if(filterEvent && !d.events.includes(filterEvent)) return;
      rows+=`
        <tr>
          <td class='border px-2 py-1'>${d.name}</td>
          <td class='border px-2 py-1'>${d.grNo}</td>
          <td class='border px-2 py-1'>${d.class}</td>
          <td class='border px-2 py-1'>${d.division}</td>
          <td class='border px-2 py-1'>${d.house}</td>
          <td class='border px-2 py-1'>${d.category}</td>
          <td class='border px-2 py-1'>${d.events.join(', ')}</td>
          <td class='border px-2 py-1'><button class='bg-red-500 text-white px-2 py-1 rounded' onclick="removeRegistration('${d.grNo}')">Remove</button></td>
        </tr>
      `;
    });
    document.getElementById('adminTable').innerHTML=rows;
  });
}

// --- Remove Registration ---
function removeRegistration(grNo){
  if(confirm('Remove this registration?')){
    db.ref('registrations/'+grNo).remove();
    loadAdminData();
  }
}

// --- Back to Registration ---
document.getElementById('backToRegistration').addEventListener('click',()=>{
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('mainContainer').classList.remove('hidden');
});

// --- Filter ---
document.getElementById('filterCategory').addEventListener('change', e=>{
  const cat=e.target.value;
  const eventSelect=document.getElementById('filterEvent');
  eventSelect.innerHTML='<option value="">Select Event</option>';
  if(eventsByCategory[cat]) eventsByCategory[cat].forEach(ev=>{
    eventSelect.innerHTML+=`<option value="${ev}">${ev}</option>`;
  });
});
document.getElementById('filterEvent').addEventListener('change', ()=>{
  loadAdminData(document.getElementById('filterCategory').value, document.getElementById('filterEvent').value);
});

// --- Download Filtered PDF ---
document.getElementById('downloadFilteredPDF').addEventListener('click', ()=>{
  db.ref('registrations').once('value', snapshot=>{
    const data = snapshot.val() || {};
    Object.values(data).forEach(generatePDF);
  });
});

// --- Export CSV ---
document.getElementById('exportCSV').addEventListener('click', ()=>{
  db.ref('registrations').once('value', snapshot=>{
    const data = snapshot.val() || {};
    const csvRows=[['Name','GR No','Class','Division','House','Category','Events']];
    Object.values(data).forEach(d=>{
      csvRows.push([d.name,d.grNo,d.class,d.division,d.house,d.category,d.events.join('; ')]);
    });
    const csvContent=csvRows.map(e=>e.join(',')).join('\n');
    const blob=new Blob([csvContent], {type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='SportsMeet2025_Registrations.csv'; a.click(); URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
