<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunrise Sports Meet Registration</title>
<!-- Modern Modular Firebase SDK (v10+) via CDN -->
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script>
<!-- Library for PDF generation -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<!-- Tailwind CSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-r from-indigo-50 to-blue-100 min-h-screen font-sans">

<!-- Registration Form -->
<div id="mainContainer" class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl mt-10 p-8 border border-blue-200">
  <h1 class="text-4xl font-bold text-center text-indigo-700 mb-2">SUNRISE ENGLISH PRIVATE SCHOOL - L.L.C - O.P.C- ABU DHBAI</h1>
  <h2 class="text-lg font-bold text-center text-gray-700 mb-6">ANNUAL SPORTS MEET 2025–2026 Registration</h2>

  <form id="sportsForm" class="space-y-4">
    <div>
      <label class="block font-semibold text-gray-700">Full Name</label>
      <input type="text" id="name" class="border p-2 w-full rounded-md" required>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold text-gray-700">GR Number</label>
        <input type="text" id="grNo" maxlength="5" class="border p-2 w-full rounded-md" required>
      </div>
      <div>
        <label class="block font-semibold text-gray-700">Class</label>
        <input type="text" id="class" class="border p-2 w-full rounded-md" required>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold text-gray-700">Division</label>
        <input type="text" id="division" class="border p-2 w-full rounded-md" required>
      </div>
      <div>
        <label class="block font-semibold text-gray-700">Sports House</label>
        <select id="house" class="border p-2 w-full rounded-md" required>
          <option value="">Select House</option>
          <option value="Ruby">Ruby</option>
          <option value="Sapphire">Sapphire</option>
          <option value="Topaz">Topaz</option>
          <option value="Emerald">Emerald</option>
        </select>
      </div>
    </div>
    <div>
      <label class="block font-semibold text-gray-700">Date of Birth</label>
      <input type="date" id="dob" class="border p-2 w-full rounded-md" required>
    </div>
    <div>
      <label class="block font-semibold text-gray-700">Category</label>
      <input type="text" id="category" class="border p-2 w-full rounded-md bg-gray-100" readonly>
    </div>

    <div id="eventsSection" class="hidden">
      <label class="block font-semibold text-gray-700 mb-2">Select Events</label>
      <div id="eventList" class="grid grid-cols-2 gap-2"></div>
      <p id="eventNote" class="text-sm text-gray-600 mt-2"></p>
    </div>

    <button type="submit" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg w-full">Submit Registration</button>
  </form>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden max-w-5xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow-lg">
  <h2 class="text-2xl font-bold text-indigo-700 mb-4 text-center">Admin Panel - Sports Meet 2025</h2>
  <div class="flex flex-wrap gap-2 mb-4">
    <select id="filterCategory" class="border p-2 rounded-md">
      <option value="">Select Category</option>
      <option value="Sub Junior">Sub Junior</option>
      <option value="Junior">Junior</option>
      <option value="Inter">Inter</option>
      <option value="Senior">Senior</option>
      <option value="Super Senior">Super Senior</option>
    </select>
    <select id="filterEvent" class="border p-2 rounded-md">
      <option value="">Select Event</option>
    </select>
    <button id="downloadFilteredPDF" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Download Filtered PDF</button>
    <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-lg">Export CSV</button>
    <button id="backToRegistration" class="bg-gray-600 text-white px-4 py-2 rounded-lg">Back to Registration</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 text-sm">
      <thead class="bg-indigo-100">
        <tr>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">GR No</th>
          <th class="border px-2 py-1">Class</th>
          <th class="border px-2 py-1">Div</th>
          <th class="border px-2 py-1">House</th>
          <th class="border px-2 py-1">Category</th>
          <th class="border px-2 py-1">Events</th>
          <th class="border px-2 py-1">Action</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </div>
</div>

<!-- Main Script Block using ES Modules -->
<script type="module">
// Import all necessary modular functions from Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  doc, 
  getDoc, 
  setDoc, 
  deleteDoc, 
  getDocs, 
  query, 
  orderBy, 
  serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/* ===== FIREBASE SETUP - USING YOUR CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC-axJOwivMy-bGhNmVIHaXORcG90gLA9g",
  authDomain: "registration-c78dc.firebaseapp.com",
  projectId: "registration-c78dc",
  storageBucket: "registration-c78dc.firebasestorage.app",
  messagingSenderId: "368136278543",
  appId: "1:368136278543:web:03a46a62d1095f40a0497a",
  measurementId: "G-14V6C8VSCH"
};

// Initialize Firebase App and Firestore Database
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const REGISTRATIONS_COLLECTION = "registrations";

/* ===== CATEGORIES & EVENTS (NO CHANGE) ===== */
const categories=[
{name:'Sub Junior',limit:2,min:new Date('2017-01-01')},
{name:'Junior',limit:3,min:new Date('2015-01-01')},
{name:'Inter',limit:3,min:new Date('2013-01-01')},
{name:'Senior',limit:4,min:new Date('2010-01-01')},
{name:'Super Senior',limit:4,min:new Date('2007-01-01')}
];

const eventsByCategory={
'Sub Junior':['100 mts','200 mts','Long Jump'],
'Junior':['100 mts','200 mts','400 mts','Long Jump'],
'Inter':['100 mts','200 mts','800 mts','Long Jump','Shot Put (4kg)'],
'Senior':['100 mts','200 mts','400 mts','800 mts','Long Jump','Shot Put','1500 mts'],
'Super Senior':['100 mts','200 mts','400 mts','800 mts','Long Jump','Shot Put','1500 mts']
};

const dobInput=document.getElementById('dob');
const categoryField=document.getElementById('category');
const eventsSection=document.getElementById('eventsSection');
const eventList=document.getElementById('eventList');
const eventNote=document.getElementById('eventNote');

/* ===== DETERMINE CATEGORY (NO CHANGE) ===== */
function getCategory(dob){
  const parts=dob.split('-');
  const birthDate=new Date(parts[0],parts[1]-1,parts[2]);
  for(let c of categories) if(birthDate>=c.min) return c.name;
  return 'Super Senior';
}

/* ===== UPDATE EVENTS (NO CHANGE) ===== */
dobInput.addEventListener('change',()=>{
  const cat=getCategory(dobInput.value);
  categoryField.value=cat;
  eventsSection.classList.remove('hidden');
  eventList.innerHTML='';
  const limit=categories.find(c=>c.name===cat).limit;
  eventNote.textContent=`You can select up to ${limit} events.`;
  eventsByCategory[cat].forEach(ev=>{
    const label=document.createElement('label');
    label.className='flex items-center space-x-2';
    label.innerHTML=`<input type='checkbox' value='${ev}' class='eventCheck'> <span>${ev}</span>`;
    eventList.appendChild(label);
  });
  document.querySelectorAll('.eventCheck').forEach(chk=>{
    chk.addEventListener('change',()=>{
      if(document.querySelectorAll('.eventCheck:checked').length>limit){
        chk.checked=false; 
        // Using custom UI alert instead of native alert()
        showMessage(`You can select only ${limit} events.`, 'error');
      }
    });
  });
});

/* ===== SUBMIT REGISTRATION (UPDATED FOR FIREBASE V10) ===== */
document.getElementById('sportsForm').addEventListener('submit',async(e)=>{
  e.preventDefault();

  const name=document.getElementById('name').value.trim();
  const grNo=document.getElementById('grNo').value.trim();
  const classV=document.getElementById('class').value.trim();
  const division=document.getElementById('division').value.trim();
  const house=document.getElementById('house').value;
  const dob=dobInput.value;
  const category=categoryField.value;
  const selectedEvents=Array.from(document.querySelectorAll('.eventCheck:checked')).map(e=>e.value);

  if(!name || !grNo || !classV || !division || !house || !dob || selectedEvents.length===0){
    showMessage('Please fill all fields and select events.', 'warning');
    return;
  }
    
  try {
    // Reference to the document using GR No as the document ID
    const regDocRef = doc(db, REGISTRATIONS_COLLECTION, grNo);
    const docSnap = await getDoc(regDocRef);

    // Check for duplicate GR No (prevention)
    if (docSnap.exists()) {
      showMessage(`A registration for GR No ${grNo} already exists.`, 'error');
      return;
    }

    // Save data to Firestore
    await setDoc(regDocRef, {
      name,
      grNo,
      class: classV,
      division,
      house,
      dob,
      category,
      events: selectedEvents,
      timestamp: serverTimestamp() // Use server timestamp for accurate sorting
    });

    showMessage('Registration successful! PDF will download.', 'success');
    
    // Generate PDF with submitted data
    generatePDF({name, grNo, class: classV, division, house, dob, category, events: selectedEvents});
    
    // Reset form
    document.getElementById('sportsForm').reset();
    categoryField.value=''; 
    eventsSection.classList.add('hidden');
    document.querySelectorAll('.eventCheck').forEach(chk => chk.checked = false); // Ensure checkboxes are cleared
    loadAdminData(); // Refresh admin panel if open

  } catch(err){
    console.error('Submission Error:', err); 
    showMessage('Error submitting registration. Check the console and ensure Firebase Rules are set to public for testing.', 'error'); 
  }
});

/* ===== GENERATE PDF (NO CHANGE) ===== */
function generatePDF(data){
  const content=document.createElement('div');
  content.style.padding='20px';
  content.style.fontFamily='Arial,sans-serif';
  content.innerHTML=`
    <div style="text-align:center;font-weight:bold;">SUNRISE ENGLISH PRIVATE SCHOOL - L.L.C - O.P.C- ABU DHBAI</div>
    <div style="text-align:center;font-weight:bold;">ANNUAL SPORTS MEET 2025-2026</div>
    <p>Dear Parents,</p>
    <p>Full Name: ${data.name}</p>
    <p>GR No: ${data.grNo}</p>
    <p>Class: ${data.class}</p>
    <p>Division: ${data.division}</p>
    <p>DOB: ${data.dob}</p>
    <p>Sports House: ${data.house}</p>
    <p>Category: ${data.category}</p>
    <p>Selected Events:</p>
    <ul>${data.events.map(e=>`<li>${e}</li>`).join('')}</ul>
    <p>Allow / Don’t Allow: ________________</p>
  `;
  html2pdf().set({margin:10,filename:`${data.name}_SportsMeet2025.pdf`,html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(content).save();
}

/* ===== ADMIN PANEL ACCESS (NO CHANGE) ===== */
document.getElementById('backToRegistration').addEventListener('click',()=>{
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('mainContainer').classList.remove('hidden');
});

const adminBtn=document.createElement('button');
adminBtn.textContent="Admin Panel";
adminBtn.className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-xl transition duration-150 ease-in-out z-50";
document.body.appendChild(adminBtn);

adminBtn.addEventListener('click',async()=>{
  const pass=prompt('Enter admin password:');
  if(pass!=="SUN2025"){ showMessage('Incorrect password.', 'error'); return;}
  document.getElementById('mainContainer').classList.add('hidden');
  document.getElementById('adminPanel').classList.remove('hidden');
  await loadAdminData();
});

/* ===== LOAD ADMIN DATA (UPDATED FOR FIREBASE V10) ===== */
async function loadAdminData(){
  try {
      // Create a query to get all documents, ordered by timestamp (newest first)
      const q = query(collection(db, REGISTRATIONS_COLLECTION), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      
      const data = [];
      querySnapshot.forEach((doc) => {
        data.push(doc.data());
      });
      
      const table=document.getElementById('adminTable');
      table.innerHTML='';

      data.forEach((d)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td class='border px-2 py-1'>${d.name}</td>
            <td class='border px-2 py-1'>${d.grNo}</td>
            <td class='border px-2 py-1'>${d.class}</td>
            <td class='border px-2 py-1'>${d.division}</td>
            <td class='border px-2 py-1'>${d.house}</td>
            <td class='border px-2 py-1'>${d.category}</td>
            <td class='border px-2 py-1'>${d.events.join(', ')}</td>
            <td class='border px-2 py-1'>
              <button data-gr="${d.grNo}" class='removeBtn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs'>Remove</button>
            </td>
          `;
          // Remove button logic (UPDATED FOR FIREBASE V10)
          tr.querySelector('.removeBtn').addEventListener('click',async(e)=>{
              const grToRemove = e.target.getAttribute('data-gr');
              if(window.confirm(`Remove registration for ${d.name} (GR No: ${grToRemove})?`)){
                  await deleteDoc(doc(db, REGISTRATIONS_COLLECTION, grToRemove));
                  loadAdminData(); // Reload table after deletion
                  showMessage(`Registration for GR No ${grToRemove} removed.`, 'success');
              }
          });

          table.appendChild(tr);
      });

      populateFilters(data);

  } catch (err) {
      console.error("Error loading admin data:", err);
      showMessage("Could not load data. Check console and ensure Firebase Rules permit reading.", 'error');
    }
}

// Helper function to populate event filters (NO CHANGE)
function populateFilters(data) {
    const filterEvent = document.getElementById('filterEvent');
    filterEvent.innerHTML = '<option value="">Select Event</option>';
    const eventSet = new Set();
    data.forEach(d => d.events.forEach(e => eventSet.add(e)));
    
    Array.from(eventSet).sort().forEach(event => {
        const option = document.createElement('option');
        option.value = event;
        option.textContent = event;
        filterEvent.appendChild(option);
    });
}


// Event listeners for filtering and downloading (NO CHANGE in logic)
document.getElementById('filterCategory').addEventListener('change', loadAdminData);
document.getElementById('filterEvent').addEventListener('change', loadAdminData);
document.getElementById('exportCSV').addEventListener('click', exportCSV);
document.getElementById('downloadFilteredPDF').addEventListener('click', downloadFilteredPDF);


// CSV Export function (NO CHANGE in logic)
function exportCSV() {
    const table = document.getElementById('adminTable');
    let csv = [];
    const rows = table.querySelectorAll('tr');

    for (const row of rows) {
        const cells = row.querySelectorAll('th, td');
        const rowData = Array.from(cells).map(cell => {
            // Remove the 'Remove' button text
            if (cell.querySelector('button')) return ''; 
            // Escape commas in cell data
            let data = cell.innerText.replace(/"/g, '""');
            return `"${data}"`;
        }).filter(d => d !== ''); // Filter out empty cells (from 'Action' column)
        csv.push(rowData.join(','));
    }

    const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = 'sports_registrations.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
}

// PDF Download function for current table view (NO CHANGE in logic)
function downloadFilteredPDF() {
    const table = document.getElementById('adminTable');
    
    // Create a printable div with the header
    const content = document.createElement('div');
    content.innerHTML = `
        <h2 style="text-align:center;font-weight:bold;">SUNRISE SPORTS MEET REGISTRATIONS (FILTERED)</h2>
    `;
    
    // Clone the table for the PDF
    const tableClone = table.parentNode.cloneNode(true);
    tableClone.style.fontSize = '10px';
    
    // Remove the 'Action' column from the cloned table
    tableClone.querySelectorAll('th:last-child, td:last-child').forEach(el => el.remove());

    content.appendChild(tableClone);

    html2pdf().set({
        margin: 10,
        filename: 'sports_registrations_filtered.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // Landscape is better for tables
    }).from(content).save();
}

/* ===== CUSTOM MESSAGE BOX (Replacing alert/confirm) ===== */
function showMessage(message, type) {
    let color = '';
    switch (type) {
        case 'success': color = 'bg-green-500'; break;
        case 'error': color = 'bg-red-500'; break;
        case 'warning': color = 'bg-yellow-500'; break;
        default: color = 'bg-blue-500';
    }

    const msgBox = document.createElement('div');
    msgBox.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-bold shadow-2xl ${color} transition-opacity duration-300`;
    msgBox.textContent = message;
    document.body.appendChild(msgBox);

    setTimeout(() => {
        msgBox.style.opacity = 0;
        setTimeout(() => msgBox.remove(), 300);
    }, 3000);
}
</script>
</body>
</html>
